Bootstrap: docker
From: nvidia/cuda:12.6.2-cudnn-devel-ubuntu22.04

%files
    LightZero LightZero
%post

    # base os
    apt-get -y update \
    apt-get install -y python3.10 python3-pip gcc g++ swig git build-essential wget\
    apt-get-clean && \
    rm -rf /var/lib/apt/lists/*

    # install miniconda
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
    bash Miniconda3-latest-Linux-x86_64.sh -b -f -p /opt/conda
    rm Miniconda3-latest-Linux-x86_64.sh


    # install conda components - add the packages you need here
    conda create -n iris python=3.10
    conda activate iris

    pip install setuptools==65.5.0
    pip install -e ./LightZero
    pip install -r ./LightZero/iris/requirements.txt

%environment
    conda activate iris

%runscript

    echo "Started here"
    cd LightZero
    echo "VirtualENV"
    echo $VIRTUAL_ENV
    echo "WANDBKEY"
    echo $WANDB_API_KEY

    which python
    which python3
    which pip
    which pip3

    python3 -V

    echo "Pip list"
    pip list

    if [ $JOB_TYPE = "pull_git" ]; then
        git pull
        git checkout $GIT_BRANCH
        git pull
    elif [ $JOB_TYPE = "run_experiment" ]; then
        echo "Running experiment"
        bash scripts/run_iris.sh
    elif [ $JOB_TYPE = "run_playground" ]; then
        echo "Running playground"
        bash scripts/run_playground.sh
    fi